<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador ‚Äì Copo Cloudinary (v5b)</title>
<style>
  :root{--gap:10px}
  *{box-sizing:border-box}
  body{font-family:system-ui,Arial;margin:16px}
  .wrap{display:grid;grid-template-columns:1fr 520px;gap:16px;align-items:start;max-width:1320px;margin:0 auto}
  @media (max-width: 1100px){ .wrap{grid-template-columns:1fr} }
  h2{margin:0 0 10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="url"],textarea,select{padding:10px 12px;font-size:16px}
  input[type="text"]{min-width:240px}
  button{padding:10px 14px;font-size:14px;cursor:pointer}
  textarea{width:100%;min-height:64px;resize:vertical}
  .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#f7f7f7;padding:6px 8px;border:1px solid #eee;margin-top:6px;word-break:break-all}
  .chip{display:inline-block;padding:3px 8px;border:1px solid #ddd;border-radius:999px;background:#fff;font-size:12px}
  .swatch{display:inline-block;width:18px;height:18px;border:1px solid #bbb;vertical-align:middle}
  .section{margin-top:10px;padding-top:8px;border-top:1px dashed #ddd}
  label{min-width:150px}
  input[type="range"]{width:220px}
  details{margin-top:6px}
  summary{cursor:pointer;color:#333}
  .subtle{color:#666;font-size:12px}
  .panel{padding:8px;border:1px solid #eee;border-radius:8px}
  .sticky{position:sticky;top:10px}
  .preview{display:block;max-width:100%;height:auto;border:1px solid #ddd}
  .tiny{font-size:11px;color:#666}
  .nowrap{white-space:nowrap}
  .hint{font-size:12px;color:#777;margin-top:-6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Controles -->
  <div class="panel">
    <h2>Produ√ß√£o r√°pida</h2>

    <div class="row">
      <input id="nome" placeholder="Primeiro nome..." autofocus />
      <button id="copyOg">Copiar link (curto)</button>
      <button id="copyMsg">Copiar texto+link</button>
      <button id="download">Baixar JPG</button>
    </div>
    <div class="tiny">Enter no campo de nome tamb√©m copia o link.</div>
    <pre id="ultimoLink" class="mono"></pre>

    <!-- Corte -->
    <div class="section">
      <div class="row">
        <label style="min-width:auto"><b>Enquadramento</b></label>
        <label class="row" style="gap:4px"><input id="fit" type="checkbox" checked> Sem corte (bordas)</label>
        <label class="row" style="gap:4px">Gravidade
          <select id="grav">
            <option value="auto" selected>auto (padr√£o)</option>
            <option value="center">center</option>
            <option value="north">topo</option>
            <option value="south">base</option>
          </select>
        </label>
      </div>
      <div class="hint">‚ÄúSem corte‚Äù usa <code>c_pad</code> (evita cortar cabe√ßa/queixo). Desmarque para usar <code>c_fill</code>.</div>
    </div>

    <!-- Mensagem -->
    <div class="section">
      <div class="row">
        <textarea id="mensagem" placeholder="Ex.: Oi, {{nome}}! D√° uma olhada üëá (use {{nome}} e {{link}})"></textarea>
        <button id="saveMsg" class="nowrap">Salvar msg padr√£o</button>
      </div>
      <div class="tiny" id="msgSaved">mensagem n√£o salva</div>
    </div>

    <!-- Destino e dom√≠nio -->
    <div class="section">
      <div class="row">
        <input id="dest" type="url" placeholder="Destino do clique (ex.: perfil do M√°rcio)" style="flex:1" />
        <button id="applyDest" class="nowrap">Usar destino</button>
      </div>
      <div class="tiny" id="destv">DESTINO: padr√£o (perfil do M√°rcio)</div>

      <div class="row" style="margin-top:6px">
        <input id="dominio" type="url" placeholder="Dom√≠nio do link (opcional)" style="flex:1" />
        <button id="applyDom" class="nowrap">Usar dom√≠nio</button>
      </div>
      <div class="tiny" id="domv">DOM√çNIO: autom√°tico (este Vercel)</div>
    </div>

    <!-- Sliders -->
    <div class="section">
      <details open>
        <summary><b>Ajustes (tempo real)</b></summary>

        <div class="row" style="margin-top:8px">
          <label>Tamanho</label>
          <input id="fs" type="range" min="10" max="120" value="27" />
          <span id="fsv" class="chip">27</span>
        </div>

        <div class="row">
          <label>Posi√ß√£o X</label>
          <input id="x" type="range" min="-300" max="300" value="140" />
          <span id="xv" class="chip">140</span>
        </div>

        <div class="row">
          <label>Posi√ß√£o Y</label>
          <input id="y" type="range" min="-300" max="300" value="50" />
          <span id="yv" class="chip">50</span>
        </div>

        <div class="row">
          <label>Cor (0 cinza ‚Ä¢ 50 marrom ‚Ä¢ 100 preto)</label>
          <input id="cor" type="range" min="0" max="100" value="35" />
          <span id="corv" class="chip">35</span>
          <span id="sw" class="swatch"></span>
        </div>

        <div class="row">
          <label>Opacidade</label>
          <input id="opac" type="range" min="0" max="100" value="65" />
          <span id="opacv" class="chip">65</span>
        </div>

        <div class="row">
          <label>Blur</label>
          <input id="blur" type="range" min="0" max="16" value="8" />
          <span id="blurv" class="chip">8</span>
        </div>

        <div class="row" style="margin-top:6px">
          <button id="copyOg2">Copiar link (com ajustes)</button>
          <button id="download2">Baixar JPG (com ajustes)</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Preview -->
  <div class="panel sticky">
    <div class="row" style="justify-content:space-between;align-items:baseline">
      <b>Preview</b>
      <span class="tiny">Imagem Cloudinary</span>
    </div>
    <img id="preview" class="preview" alt="preview" />
  </div>
</div>

<script>
  // ==== CONFIG ====
  const CLOUD    = 'dr3r1szcw';
  const PUBLICID = 'v1758136687/copo_qyzeoa.jpg';
  const DEF = { f:27, x:140, y:50, c:'2b2b2b', o:65, b:8, g:'auto', m:'pad' };
  let CLICK_DEST = 'https://www.linkedin.com/in/marciomiranda/';
  let CUSTOM_ORIGIN = '';
  let MSG_TEMPLATE = 'Oi, {{nome}}! D√° uma olhada üëá';

  const $ = id => document.getElementById(id);
  const enc = s => encodeURIComponent((s||'').trim());

  // prefs
  function savePref(){ localStorage.setItem('cfg', JSON.stringify({CLICK_DEST, CUSTOM_ORIGIN, MSG_TEMPLATE})); }
  function loadPref(){
    try{
      const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
      if(cfg.CLICK_DEST) CLICK_DEST = cfg.CLICK_DEST;
      if(cfg.CUSTOM_ORIGIN) CUSTOM_ORIGIN = cfg.CUSTOM_ORIGIN;
      if(cfg.MSG_TEMPLATE) MSG_TEMPLATE = cfg.MSG_TEMPLATE;
    }catch{}
  }

  // cores util
  function hex(n){ return Math.round(n).toString(16).padStart(2,'0'); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function lerpColor(c1,c2,t){ return [
    Math.round(lerp(c1[0],c2[0],t)),
    Math.round(lerp(c1[1],c2[1],t)),
    Math.round(lerp(c1[2],c2[2],t))
  ];}
  function rgbToHex([r,g,b]){ return `#${hex(r)}${hex(g)}${hex(b)}`; }
  function colorFromSlider(v){
    const p = Math.max(0, Math.min(100, Number(v)));
    const gray=[0x44,0x44,0x44], brown=[0x3a,0x2f,0x25], blacky=[0x1f,0x1f,0x1f];
    const t = p<=50 ? p/50 : (p-50)/50;
    const rgb = p<=50 ? lerpColor(gray,brown,t) : lerpColor(brown,blacky,t);
    return rgbToHex(rgb).replace('#','');
  }

  function getParams(){
    const m = $('fit').checked ? 'pad' : 'fill';
    const g = $('grav').value || 'auto';
    return {
      f: Number($('fs').value || DEF.f),
      x: Number($('x').value  || DEF.x),
      y: Number($('y').value  || DEF.y),
      c: colorFromSlider($('cor').value || 35),
      o: Number($('opac').value || DEF.o),
      b: Number($('blur').value || DEF.b),
      g, m
    };
  }

  function originForLink(){ return (CUSTOM_ORIGIN || location.origin).replace(/\/+$/,''); }

  function buildCloudinaryURL(nome, p=getParams()){
    const base  = `https://res.cloudinary.com/${CLOUD}/image/upload/`;
    const ltxt  = `l_text:Permanent%20Marker_${p.f}:${enc(nome)},co_rgb:${p.c}${p.o>0?`,o_${p.o}`:''}${p.b>0?`,e_blur:${p.b}`:''}`;
    const apply = `fl_layer_apply,g_center,x_${p.x},y_${p.y}`;
    const box   = (p.m==='pad')
      ? `c_pad,${p.g!=='center'?'g_'+p.g+',':''}w_1200,h_627,b_auto`
      : `c_fill,g_${p.g},w_1200,h_627`;
    return `${base}${ltxt}/${apply}/${box}/${PUBLICID}`;
  }

  function qsShort(p){
    const out = [];
    if (p.f !== DEF.f) out.push('f='+p.f);
    if (p.x !== DEF.x) out.push('x='+p.x);
    if (p.y !== DEF.y) out.push('y='+p.y);
    if (p.c !== DEF.c) out.push('c='+p.c);
    if (p.o !== DEF.o) out.push('o='+p.o);
    if (p.b !== DEF.b) out.push('b='+p.b);
    if (p.g !== DEF.g) out.push('g='+p.g);
    if (p.m !== DEF.m) out.push('m='+p.m);
    out.unshift('n='+enc($('nome').value || ''));
    out.push('d='+enc(CLICK_DEST));
    return out.join('&');
  }

  function buildOgLinkShort(){
    const o = originForLink();
    const p = getParams();
    return `${o}/p?${qsShort(p)}`;
  }

  async function downloadImage(url, filename='copo.jpg'){
    const resp = await fetch(url, {mode:'cors'});
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function interpolateMsg(nome, link){
    return (MSG_TEMPLATE || '').replace(/\{\{\s*nome\s*\}\}/gi, nome).replace(/\{\{\s*link\s*\}\}/gi, link);
  }

  function refreshPreview(){
    const nome = $('nome').value || ' ';
    const p = getParams();
    const url = buildCloudinaryURL(nome, p);
    $('preview').src = url;
    $('fsv').textContent = p.f;
    $('xv').textContent  = p.x;
    $('yv').textContent  = p.y;
    $('corv').textContent= $('cor').value;
    $('opacv').textContent= p.o;
    $('blurv').textContent= p.b;
    $('sw').style.background = '#' + p.c;
    $('ultimoLink').textContent = buildOgLinkShort();
  }

  // Bot√µes
  $('copyOg').onclick = async () => {
    const nome = $('nome').value || '';
    if (!nome.trim()) { alert('Digite o nome.'); return; }
    const link = buildOgLinkShort();
    await navigator.clipboard.writeText(link);
    $('ultimoLink').textContent = link;
  };
  $('copyMsg').onclick = async () => {
    const nome = $('nome').value || '';
    if (!nome.trim()) { alert('Digite o nome.'); return; }
    const link = buildOgLinkShort();
    const msg  = interpolateMsg(nome, link);
    await navigator.clipboard.writeText(msg || link);
    $('ultimoLink').textContent = msg || link;
  };
  $('download').onclick = async () => {
    const nome = $('nome').value || '';
    if (!nome.trim()) { alert('Digite o nome.'); return; }
    const img = buildCloudinaryURL(nome, getParams());
    await downloadImage(img, `copo-${nome}.jpg`);
    $('ultimoLink').textContent = img;
  };

  // Com ajustes
  $('copyOg2').onclick = async () => {
    const nome = $('nome').value || '';
    if (!nome.trim()) { alert('Digite o nome.'); return; }
    const link = buildOgLinkShort();
    await navigator.clipboard.writeText(link);
    $('ultimoLink').textContent = link;
  };
  $('download2').onclick = async () => {
    const nome = $('nome').value || '';
    if (!nome.trim()) { alert('Digite o nome.'); return; }
    const img = buildCloudinaryURL(nome, getParams());
    await downloadImage(img, `copo-${nome}.jpg`);
    $('ultimoLink').textContent = img;
  };

  // Aplicar destino/ dom√≠nio
  $('applyDest').onclick = () => {
    const v = $('dest').value.trim();
    CLICK_DEST = v || 'https://www.linkedin.com/in/marciomiranda/';
    savePref(); $('destv').textContent = 'DESTINO: ' + CLICK_DEST;
    refreshPreview();
  };
  $('applyDom').onclick = () => {
    const v = $('dominio').value.trim().replace(/\/$/, '');
    CUSTOM_ORIGIN = v || '';
    savePref(); $('domv').textContent = CUSTOM_ORIGIN ? ('DOM√çNIO: ' + CUSTOM_ORIGIN) : 'DOM√çNIO: autom√°tico (este Vercel)';
    refreshPreview();
  };

  // Mensagem
  $('saveMsg').onclick = () => {
    MSG_TEMPLATE = $('mensagem').value;
    savePref(); $('msgSaved').textContent = 'mensagem salva';
  };

  // Eventos
  ['nome','fs','x','y','cor','opac','blur','fit','grav'].forEach(id => {
    document.getElementById(id).addEventListener('input', refreshPreview);
  });
  $('nome').addEventListener('keydown', e => { if(e.key==='Enter') $('copyOg').click(); });

  // Boot
  loadPref();
  $('mensagem').value = MSG_TEMPLATE || '';
  refreshPreview();
</script>
</body>
</html>
